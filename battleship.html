<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–æ—Ä—Å–∫–æ–π –±–æ–π ‚Äî 2√ó2</title>
<style>
  :root{
    --bg:#0f1320; --card:#161a2b; --text:#e7eaf6; --muted:#a9b0c7; --accent:#5b7cfa; --grid:#2a2f45;
    --ok:#1f9d55; --bad:#e11d48; --border:rgba(255,255,255,.12);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7fb; --card:#fff; --text:#0f1222; --muted:#4f5b78; --accent:#3b82f6; --grid:#dfe3f0; --ok:#15803d; --bad:#b91c1c; --border:rgba(0,0,0,.12); }
  }
  html[data-theme="light"]{ --bg:#f6f7fb; --card:#fff; --text:#0f1222; --muted:#4f5b78; --accent:#3b82f6; --grid:#dfe3f0; --ok:#15803d; --bad:#b91c1c; --border:rgba(0,0,0,.12); }
  html[data-theme="dark"] { --bg:#0f1320; --card:#161a2b; --text:#e7eaf6; --muted:#a9b0c7; --accent:#5b7cfa; --grid:#2a2f45; --ok:#1f9d55; --bad:#e11d48; --border:rgba(255,255,255,.12); }

  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--text);}
  .wrap{max-width:980px; margin:auto; padding:18px; position:relative}
  h1{margin:.2em 0 .3em; font-size:clamp(22px,4vw,32px)}
  .sub{color:var(--muted); margin-bottom:10px}
  .panel{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  button{background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer}
  button.secondary{background:transparent; border:1px solid var(--grid); color:var(--text)}
  .status{min-height:24px; font-weight:700}
  .fleet{color:var(--muted)}
  a{color:var(--accent)}
  details{background:var(--card); border:1px solid var(--grid); border-radius:12px; padding:10px 12px}
  summary{cursor:pointer; font-weight:700}

  /* –î–æ—Å–∫–∏ –∏ —è—á–µ–π–∫–∏ */
  .boards{display:flex;flex-direction:column;gap:16px;align-items:center}
  .enemy,.you{transition:transform .25s ease}
  .board{display:grid; grid-template-columns: repeat(11, min(38px,8.3vw)); grid-auto-rows:min(38px,8.3vw); user-select:none}
  .cell, .corner, .axis{display:flex; align-items:center; justify-content:center; border:1px solid var(--grid); background:var(--card); border-radius:8px; font-size:22px}
  .corner{background:transparent; border:0}
  .axis{font-size:14px; color:var(--muted); background:transparent; border:0}

  /* –§–∞–∑—ã: –¥–æ —Å—Ç–∞—Ä—Ç–∞ ‚Äî —Ç–≤–æ—è –¥–æ—Å–∫–∞ —Å–Ω–∏–∑—É –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è, –≤—Ä–∞–≥ —Å–≤–µ—Ä—Ö—É –ø–æ–º–µ–Ω—å—à–µ.
     –ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî —Ç–≤–æ—è –¥–æ—Å–∫–∞ –Ω–∞–≤–µ—Ä—Ö—É –∏ –º–µ–Ω—å—à–µ; –≤—Ä–∞–≥ —Å–Ω–∏–∑—É –∏ –∫—Ä—É–ø–Ω–µ–µ. */
  body.phase-place .enemy{order:1; transform:scale(.85)}
  body.phase-place .you{order:2; transform:scale(1)}
  body.phase-fight .you{order:1; transform:scale(.85)}
  body.phase-fight .enemy{order:2; transform:scale(1.12)}

  .good{color:var(--ok)} .bad{color:var(--bad)}

  /* ===== –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é (–ò–≥—Ä—ã + –¢–µ–º–∞) ===== */
  .menu{position:fixed; right:12px; top:12px; z-index:10}
  .menu summary{
    list-style:none; cursor:pointer; background:var(--accent); color:#fff; border:0;
    padding:8px 12px; border-radius:12px; font-weight:700; box-shadow:0 6px 16px rgba(0,0,0,.25)
  }
  .menu summary::-webkit-details-marker{display:none}
  .menu[open] summary{filter:brightness(.95)}
  .menuPanel{
    margin-top:8px; right:0; position:absolute; min-width:240px;
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:10px;
    box-shadow:0 16px 40px rgba(0,0,0,.35)
  }
  .menu h4{margin:6px 8px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em}
  .menu nav a{display:block; padding:8px 10px; color:var(--text); text-decoration:none; border-radius:10px}
  .menu nav a:hover{background:rgba(127,127,127,.12)}
  .themeRow{display:grid; gap:8px; padding:6px 8px 4px}
  .themeRow select{background:transparent; color:var(--text); border:1px solid var(--grid); border-radius:10px; padding:8px 10px}
  @media (prefers-color-scheme: light){
    html[data-theme="light"] .themeRow select{border:1px solid #ccc; background:#fff; color:#000}
  }
  @media (max-width:640px){ .enemy{transform:scale(.78)} }
</style>
</head>
<body>
<!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é -->
<details class="menu">
  <summary>–ú–µ–Ω—é ‚ñæ</summary>
  <div class="menuPanel" role="menu">
    <h4>–ò–≥—Ä—ã</h4>
    <nav>
      <a href="index.html">üßÆ –ü—Ä–∏–º–µ—Ä—ã (—Ç—Ä–µ–Ω–∞–∂—ë—Ä)</a>
      <a href="battleship.html">üö¢ –ú–æ—Ä—Å–∫–æ–π –±–æ–π</a>
      <a href="cities.html">üåç –ì–æ—Ä–æ–¥–∞</a>
      <a href="minesweeper.html">üí£ –°–∞–ø—ë—Ä</a>
      <a href="tictactoe.html">‚ùå‚≠ï –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</a>
    </nav>
    <h4>–¢–µ–º–∞</h4>
    <div class="themeRow">
      <select id="theme" aria-label="–¢–µ–º–∞">
        <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        <option value="dark">–¢—ë–º–Ω–∞—è</option>
        <option value="system" selected>–ö–∞–∫ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</option>
      </select>
    </div>
  </div>
</details>

<div class="wrap">
  <h1>üö¢ –ú–æ—Ä—Å–∫–æ–π –±–æ–π ‚Äî —Ä–µ–∂–∏–º 2√ó2</h1>
  <div class="sub">–°—Ç–∞–≤—å —Ñ–ª–æ—Ç –Ω–∞ —Å–≤–æ—ë–º –ø–æ–ª–µ, –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª, –∑–∞—Ç–µ–º —Å—Ç—Ä–µ–ª—è–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.</div>

  <div class="panel">
    <div class="left">
      <button id="rotate" class="secondary" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –∫–æ—Ä–∞–±–ª—å">‚Üï –ü–æ–≤–µ—Ä–Ω—É—Ç—å</button>
      <button id="start" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button id="restart" class="secondary">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      <span class="fleet" id="fleetInfo"></span>
    </div>
    <div class="status" id="status"></div>
  </div>

  <div class="boards" id="boards">
    <div class="enemy">
      <h3 style="margin:6px 0 8px; color:var(--muted)">–ü–æ–ª–µ —Å–∞–π—Ç–∞ (—Å—Ç—Ä–µ–ª—è–π —Å—é–¥–∞)</h3>
      <div id="enemyBoard" class="board"></div>
    </div>
    <div class="you">
      <h3 style="margin:6px 0 8px; color:var(--muted)">–¢–≤–æ—ë –ø–æ–ª–µ (—Ä–∞—Å—Å—Ç–∞–≤—å —Ñ–ª–æ—Ç)</h3>
      <div id="yourBoard" class="board"></div>
    </div>
  </div>

  <div style="margin-top:16px">
    <details>
      <summary>–ü—Ä–∞–≤–∏–ª–∞</summary>
      <div style="margin-top:8px; line-height:1.6">
        <p><b>–¶–µ–ª—å:</b> –ø–µ—Ä–≤—ã–º –ø–æ—Ç–æ–ø–∏—Ç—å –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.</p>
        <p><b>–ü–æ–ª–µ:</b> –¥–≤–∞ –ø–æ–ª—è –ø–æ 10√ó10. –ö–æ—Ä–∞–±–ª–∏ –Ω–µ –∫–∞—Å–∞—é—Ç—Å—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –Ω–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏, –Ω–∏ —É–≥–ª–∞–º–∏.</p>
        <p><b>–§–ª–æ—Ç:</b> 1√ó4 ‚Äî 1 —à—Ç, 1√ó3 ‚Äî 2 —à—Ç, 1√ó2 ‚Äî 3 —à—Ç, 1√ó1 ‚Äî 4 —à—Ç.</p>
        <p><b>–•–æ–¥ –∏–≥—Ä—ã:</b> —Ö–æ–¥ –ø–æ –æ–¥–Ω–æ–º—É –≤—ã—Å—Ç—Ä–µ–ª—É. –ü–æ–ø–∞–¥–∞–Ω–∏–µ –¥–∞—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Å—Ç—Ä–µ–ª; –ø—Ä–æ–º–∞—Ö ‚Äî —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫—É. –ò–ò —Å—Ç—Ä–µ–ª—è–µ—Ç ¬´–ø–æ-—á–µ—Å—Ç–Ω–æ–º—É¬ª (–±–µ–∑ –∑–Ω–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π) –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –æ—Ç –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π.</p>
        <p><b>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:</b> –≤–æ–¥–∞ ‚Äî üåä, —Ç–≤–æ–π –∫–æ—Ä–∞–±–ª—å ‚Äî üö¢, –ø—Ä–æ–º–∞—Ö ‚Äî ‚ö™Ô∏è, –ø–æ–ø–∞–¥–∞–Ω–∏–µ ‚Äî üí•, —É—Ç–æ–Ω—É–ª ‚Äî ‚ò†Ô∏è.</p>
        <p><b>–ö–∞–∫ –Ω–∞—á–∞—Ç—å:</b> —Ä–∞—Å—Å—Ç–∞–≤—å —Ñ–ª–æ—Ç –∫–ª–∏–∫–∞–º–∏ –ø–æ —Å–≤–æ–µ–º—É –ø–æ–ª—é; ¬´‚Üï –ü–æ–≤–µ—Ä–Ω—É—Ç—å¬ª –º–µ–Ω—è–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é. –ö–æ–≥–¥–∞ —Ñ–ª–æ—Ç –≥–æ—Ç–æ–≤ ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª —Å—Ç–∞–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π.</p>
      </div>
    </details>
  </div>

  <div style="margin-top:14px"><a href="index.html">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç—Ä–µ–Ω–∞–∂—ë—Ä—É</a></div>
</div>

<script>
(function(){
  // ---------- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã/—ç–º–æ–¥–∑–∏ ----------
  const SIZE = 10;
  const FLEET_PATTERN = [4,3,3,2,2,2,1,1,1,1]; // –∫–ª–∞—Å—Å–∏–∫–∞
  const EMOJI = { water:"üåä", ship:"üö¢", miss:"‚ö™Ô∏è", hit:"üí•", sunk:"‚ò†Ô∏è" };

  // ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ----------
  let your = makeEmpty();
  let enemy = makeEmpty();
  let yourShips=[], enemyShips=[];
  let placing = { sizes:[...FLEET_PATTERN], dir:"H" }; // H/V
  let phase = "place"; // place | fight | over
  let turn = "you"; // you | enemy
  let lastEnemyHit = null;
  let aiHotStreak = 0;

  const elYour = document.getElementById("yourBoard");
  const elEnemy = document.getElementById("enemyBoard");
  const statusEl = document.getElementById("status");
  const startBtn = document.getElementById("start");
  const rotateBtn = document.getElementById("rotate");
  const restartBtn = document.getElementById("restart");
  const fleetInfo = document.getElementById("fleetInfo");
  const menu = document.querySelector('.menu');

  // ---------- –†–∞–∑–º–µ—Ç–∫–∞ —Å–µ—Ç–æ–∫ —Å –æ—Å—è–º–∏ ----------
  renderGrid(elYour, true);
  renderGrid(elEnemy, false);
  updateFleetInfo();
  status("–†–∞—Å—Å—Ç–∞–≤—å —Ñ–ª–æ—Ç. –¢–µ–∫—É—â–∏–π –∫–æ—Ä–∞–±–ª—å: " + placing.sizes[0] + " –∫–ª–µ—Ç–∫–∏.");
  document.body.classList.add("phase-place");

  // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ ----------
  enemyShips = randomFleet();
  applyFleetToBoard(enemy, enemyShips);

  // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ----------
  rotateBtn.onclick = () => {
    placing.dir = placing.dir === "H" ? "V" : "H";
    status("–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: " + (placing.dir==="H"?"–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ":"–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ") +
           ". –¢–µ–∫—É—â–∏–π –∫–æ—Ä–∞–±–ª—å: " + (placing.sizes[0] || "‚Äî"));
  };

  restartBtn.onclick = () => {
    // —Å–±—Ä–æ—Å
    your = makeEmpty(); enemy = makeEmpty();
    yourShips = []; enemyShips = [];
    placing = { sizes:[...FLEET_PATTERN], dir:"H" };
    phase = "place"; turn = "you"; lastEnemyHit = null; aiHotStreak=0;

    clearBoardUI(elYour); clearBoardUI(elEnemy);
    renderGrid(elYour, true); renderGrid(elEnemy, false);
    enemyShips = randomFleet(); applyFleetToBoard(enemy, enemyShips);
    updateFleetInfo();
    startBtn.disabled = true;

    // –≤–µ—Ä–Ω—É—Ç—å —Ñ–∞–∑—É –∏ –ø–æ—Ä—è–¥–æ–∫
    document.body.classList.remove("phase-fight");
    document.body.classList.add("phase-place");
    const boards = document.getElementById("boards");
    const enemyBox = boards.querySelector(".enemy");
    const youBox = boards.querySelector(".you");
    boards.insertBefore(enemyBox, youBox); // –≤—Ä–∞–≥ —Å–≤–µ—Ä—Ö—É, —Ç—ã —Å–Ω–∏–∑—É

    status("–†–∞—Å—Å—Ç–∞–≤—å —Ñ–ª–æ—Ç. –¢–µ–∫—É—â–∏–π –∫–æ—Ä–∞–±–ª—å: " + placing.sizes[0] + " –∫–ª–µ—Ç–∫–∏.");
  };

  startBtn.onclick = () => {
    if (phase!=="place") return;
    phase = "fight";
    // —Ñ–∞–∑–∞ –±–æ—è –∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞: –≤—Ä–∞–≥ –≤–Ω–∏–∑, –∫—Ä—É–ø–Ω—ã–π; —Ç—ã –≤–≤–µ—Ä—Ö, –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π
    document.body.classList.remove("phase-place");
    document.body.classList.add("phase-fight");
    const boards = document.getElementById("boards");
    const enemyBox = boards.querySelector(".enemy");
    boards.appendChild(enemyBox);
    status("–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –¢–≤–æ–π —Ö–æ–¥. –°—Ç—Ä–µ–ª—è–π –ø–æ –Ω–∏–∂–Ω–µ–º—É –ø–æ–ª—é.");
  };

  // –ö–ª–∏–∫ –ø–æ —Ç–≤–æ–µ–º—É –ø–æ–ª—é ‚Äî –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª—è –≤ —Ñ–∞–∑–µ place
  elYour.addEventListener("click", (e)=>{
    if (phase!=="place") return;
    const cell = e.target.closest("[data-x]");
    if (!cell) return;
    const x = +cell.dataset.x, y = +cell.dataset.y;
    const size = placing.sizes[0];
    if (!size) return;
    const ship = { x, y, len:size, dir:placing.dir, hits:0, coords:[] };
    if (!canPlace(your, ship)) { flashBad(cell); return; }
    placeShip(your, ship);
    yourShips.push(ship);
    drawYourBoard();
    placing.sizes.shift();
    updateFleetInfo();
    if (!placing.sizes.length) {
      startBtn.disabled = false;
      status("–§–ª–æ—Ç –≥–æ—Ç–æ–≤. –ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª.");
    } else {
      status("–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å: " + placing.sizes.join(", ") + ". –¢–µ–∫—É—â–∏–π ‚Äî " + placing.sizes[0]);
    }
  });

  // –ö–ª–∏–∫ –ø–æ –≤—Ä–∞–∂–µ—Å–∫–æ–º—É –ø–æ–ª—é ‚Äî –≤—ã—Å—Ç—Ä–µ–ª –≤ —Ñ–∞–∑–µ fight
  elEnemy.addEventListener("click", (e)=>{
    if (phase!=="fight" || turn!=="you") return;
    const cell = e.target.closest("[data-x]");
    if (!cell) return;
    const x = +cell.dataset.x, y = +cell.dataset.y;
    const tile = enemy[y][x];
    if (tile.shot) return; // —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª
    shootAt(enemy, enemyShips, x, y, true);
  });

  // ---------- –§—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—è/–æ—Ç—Ä–∏—Å–æ–≤–∫–∏ ----------
  function makeEmpty(){
    return Array.from({length:SIZE}, ()=> Array.from({length:SIZE}, ()=>({
      ship:false, shot:false, sunk:false
    })));
  }

  function renderGrid(container, isYou){
    container.innerHTML = "";
    // –æ—Å–∏
    container.appendChild(axisCell("corner"));
    for(let x=0; x<SIZE; x++) container.appendChild(axisCell("axis", String.fromCharCode(65+x)));
    for(let y=0; y<SIZE; y++){
      container.appendChild(axisCell("axis", String(y+1)));
      for(let x=0; x<SIZE; x++){
        const c = document.createElement("div");
        c.className = "cell";
        c.dataset.x = x; c.dataset.y = y;
        c.textContent = EMOJI.water;
        container.appendChild(c);
      }
    }
    if (isYou) drawYourBoard(); else drawEnemyBoard();
  }

  function axisCell(cls, txt=""){
    const d = document.createElement("div");
    d.className = cls==="corner"?"corner":"axis";
    d.textContent = txt;
    return d;
  }

  function clearBoardUI(container){ /* –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –≤ renderGrid */ }

  function forEachCell(container, fn){
    // —É—á–µ—Å—Ç—å –æ—Å–∏: 11√ó11, —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏/—Å—Ç—Ä–æ–∫–∏
    for(let y=0;y<SIZE;y++){
      for(let x=0;x<SIZE;x++){
        const i = 1 + SIZE + y*(SIZE+1) + 1 + x;
        const el = container.children[i];
        fn(x,y,el);
      }
    }
  }

  function drawYourBoard(){
    forEachCell(elYour, (x,y,el)=>{
      const t = your[y][x];
      if (t.sunk) el.textContent = EMOJI.sunk;
      else if (t.shot && t.ship) el.textContent = EMOJI.hit;
      else if (t.shot && !t.ship) el.textContent = EMOJI.miss;
      else if (t.ship) el.textContent = EMOJI.ship;
      else el.textContent = EMOJI.water;
    });
  }

  function drawEnemyBoard(){
    forEachCell(elEnemy, (x,y,el)=>{
      const t = enemy[y][x];
      if (t.sunk) el.textContent = EMOJI.sunk;
      else if (t.shot && t.ship) el.textContent = EMOJI.hit;
      else if (t.shot && !t.ship) el.textContent = EMOJI.miss;
      else el.textContent = EMOJI.water;
    });
  }

  // ---------- –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π ----------
  function canPlace(board, ship){
    const {x,y,len,dir} = ship;
    if (dir==="H"){
      if (x+len-1 >= SIZE) return false;
      for(let i=0;i<len;i++){ if (!cellFree(board, x+i, y)) return false; }
      for(let i=-1;i<=len;i++){
        for(let dy=-1; dy<=1; dy++){
          const nx = x+i, ny = y+dy;
          if (inside(nx,ny) && board[ny][nx]?.ship) return false;
        }
      }
    } else {
      if (y+len-1 >= SIZE) return false;
      for(let i=0;i<len;i++){ if (!cellFree(board, x, y+i)) return false; }
      for(let i=-1;i<=len;i++){
        for(let dx=-1; dx<=1; dx++){
          const nx = x+dx, ny = y+i;
          if (inside(nx,ny) && board[ny][nx]?.ship) return false;
        }
      }
    }
    return true;
  }
  function cellFree(board, x,y){ return inside(x,y) && !board[y][x].ship; }
  function inside(x,y){ return x>=0 && x<SIZE && y>=0 && y<SIZE; }

  function placeShip(board, ship){
    const {x,y,len,dir} = ship;
    ship.coords = [];
    if (dir==="H"){
      for(let i=0;i<len;i++){ board[y][x+i].ship = true; ship.coords.push([x+i,y]); }
    } else {
      for(let i=0;i<len;i++){ board[y+i][x].ship = true; ship.coords.push([x,y+i]); }
    }
  }

  function randomFleet(){
    const board = makeEmpty();
    const ships = [];
    for (const len of FLEET_PATTERN){
      let placed = false, guard=0;
      while(!placed && guard<500){
        guard++;
        const dir = Math.random()<.5 ? "H" : "V";
        const x = rand(0, SIZE-1), y = rand(0, SIZE-1);
        const s = {x,y,len,dir,hits:0,coords:[]};
        if (canPlace(board, s)){ placeShip(board, s); ships.push(s); placed = true; }
      }
    }
    return ships;
  }

  function applyFleetToBoard(board, ships){
    ships.forEach(s => s.coords.forEach(([x,y])=> board[y][x].ship = true));
  }

  // ---------- –°—Ç—Ä–µ–ª—å–±–∞ ----------
  function shootAt(board, ships, x, y, isYou){
    const t = board[y][x];
    t.shot = true;
    let hit = false;
    if (t.ship){
      hit = true;
      const ship = ships.find(s => s.coords.some(([cx,cy])=>cx===x && cy===y));
      ship.hits++;
      if (ship.hits >= ship.len){ ship.coords.forEach(([cx,cy])=> board[cy][cx].sunk = true); }
    }
    if (isYou){
      drawEnemyBoard();
      if (isAllSunk(ships)) return endGame("–¢—ã –ø–æ–±–µ–¥–∏–ª! üèÜ");
      if (hit){ status("–ü–æ–ø–∞–¥–∞–Ω–∏–µ! –°—Ç—Ä–µ–ª—è–π –µ—â—ë."); }
      else { status("–ü—Ä–æ–º–∞—Ö. –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶"); turn = "enemy"; setTimeout(aiTurn, 600); }
    } else {
      drawYourBoard();
      if (isAllSunk(ships)) return endGame("–°–∞–π—Ç –ø–æ–±–µ–¥–∏–ª. –ü–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑?");
      if (hit){
        aiHotStreak++; // –æ–≥—Ä–∞–Ω–∏—á–∏–º —Å–µ—Ä–∏–∏
        if (aiHotStreak < 2){ status("–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–ø–∞–ª –∏ —Å—Ç—Ä–µ–ª—è–µ—Ç –µ—â—ë‚Ä¶"); setTimeout(aiTurn, 700); }
        else { aiHotStreak = 0; turn = "you"; status("–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–ø–∞–ª. –¢–≤–æ–π —Ö–æ–¥!"); }
      } else {
        aiHotStreak = 0; turn = "you"; status("–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è. –¢–≤–æ–π —Ö–æ–¥!");
      }
    }
  }

  function isAllSunk(ships){ return ships.every(s => s.hits >= s.len); }
  function endGame(msg){ phase = "over"; status(msg); }
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function status(text){ statusEl.textContent = text; }

  // ---------- –•–æ–¥ –ò–ò ----------
  function aiTurn(){
    if (phase!=="fight") return;
    let target = null;
    const candidates = [];
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      if (!your[y][x].shot) candidates.push([x,y]);
    }
    if (lastEnemyHit){
      const [hx,hy] = lastEnemyHit;
      const around = [[hx+1,hy],[hx-1,hy],[hx,hy+1],[hx,hy-1]].filter(([x,y])=>inside(x,y)&&!your[y][x].shot);
      if (around.length) target = around[Math.floor(Math.random()*around.length)];
      else lastEnemyHit = null;
    }
    if (!target){ target = weightedPick(candidates); }
    const [x,y] = target;
    const wasShip = your[y][x].ship;
    shootAt(your, yourShips, x, y, false);
    if (wasShip && your[y][x].shot){ lastEnemyHit = [x,y]; }
    else if (!wasShip){ lastEnemyHit = null; }
  }

  function weightedPick(cands){
    const good = [], rest = [];
    for (const [x,y] of cands){
      const neigh = [[1,0],[-1,0],[0,1],[0,-1]];
      let missAdj = 0;
      for (const [dx,dy] of neigh){
        const nx=x+dx, ny=y+dy;
        if (inside(nx,ny) && your[ny][nx].shot && !your[ny][nx].ship) missAdj++;
      }
      (missAdj>=2 ? rest : good).push([x,y]);
    }
    const pool = good.length?good:rest;
    return pool[Math.floor(Math.random()*pool.length)];
  }

  // ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ----------
  function updateFleetInfo(){
    if (!placing.sizes.length) { fleetInfo.textContent = "–§–ª–æ—Ç –≥–æ—Ç–æ–≤."; return; }
    const left = [...placing.sizes].sort((a,b)=>b-a).join(", ");
    fleetInfo.textContent = "–û—Å—Ç–∞–ª–æ—Å—å: " + left;
  }

  function flashBad(cell){
    cell.style.outline = "2px solid var(--bad)";
    setTimeout(()=> cell.style.outline = "", 300);
  }

  function drawYourBoardInitial(){ drawYourBoard(); drawEnemyBoard(); }
  drawYourBoardInitial();

  // –ê–≤—Ç–æ-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ¬´–ù–∞—á–∞—Ç—å¬ª, –ø–æ–∫–∞ —Ñ–ª–æ—Ç –Ω–µ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω
  const observer = new MutationObserver(()=>{ startBtn.disabled = placing.sizes.length>0 || phase!=="place"; });
  observer.observe(fleetInfo, {childList:true});

  // ---------- –¢–µ–º–∞ (–≤ –º–µ–Ω—é) ----------
  const themeSel = document.getElementById("theme");
  function applyTheme(mode){
    document.documentElement.setAttribute("data-theme", mode);
    localStorage.setItem("battleship-theme", mode);
    if(mode==="system"){ document.documentElement.setAttribute("data-theme","system"); }
  }
  (function initTheme(){
    const saved = localStorage.getItem("battleship-theme") || "system";
    themeSel.value = saved; applyTheme(saved);
    const mq = window.matchMedia("(prefers-color-scheme: dark)");
    mq.addEventListener("change", ()=>{ if((localStorage.getItem("battleship-theme")||"system")==="system") applyTheme("system"); });
  })();
  themeSel.addEventListener("change", ()=> { applyTheme(themeSel.value); document.querySelector('.menu').open=false; });

  // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –º–µ–Ω—é –ø–æ –∫–ª–∏–∫—É –ø–æ —Å—Å—ã–ª–∫–µ
  document.querySelectorAll('.menu nav a').forEach(a=>{
    a.addEventListener('click', ()=> { menu.open = false; });
  });

  // ---------- –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞/–≤–∞–ª–∏–¥–∞—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—ã—à–µ) ----------
  function forEachShipCell(board, fn){
    for (let y=0;y<SIZE;y++) for (let x=0;x<SIZE;x++) if (board[y][x].ship) fn(x,y);
  }

})();
</script>
</body>
</html>
